---
title: "Comparison of the Transcriptomic Atlas of the Human Retina and Mouse Retina"
output: html_notebook
---
# Setup
Load libraries
```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
library(Matrix)
library(Seurat)
library(cowplot)
```
Download Human Data
```{r}
import_remote_data <- function(file_url, type = "table", header = FALSE) {
  con <- gzcon(url(file_url))
  txt <- readLines(con)
  if (type == "MM") { return (readMM(textConnection(txt))) }
  if (type == "table") { return (read.table(textConnection(txt), header = header)) }
}

count_matrix_URL <- "https://ftp.ncbi.nlm.nih.gov/geo/series/GSE137nnn/GSE137537/suppl/GSE137537_counts.mtx.gz"
gene_names_URL <- "https://ftp.ncbi.nlm.nih.gov/geo/series/GSE137nnn/GSE137537/suppl/GSE137537_gene_names.txt.gz"
sample_annotations_URL <- "https://ftp.ncbi.nlm.nih.gov/geo/series/GSE137nnn/GSE137537/suppl/GSE137537_sample_annotations.tsv.gz"

count_matrix <- as.matrix(import_remote_data(count_matrix_URL, type = "MM"))
gene_names <- import_remote_data(gene_names_URL, type = "table")
sample_annotations <- import_remote_data(sample_annotations_URL, type = "table", header = TRUE)
```
Refactor data for Seurat analysis
```{r}
remove_dup_features <- function(count.matrix) {
  ind.dup <- which(duplicated(dimnames(count.matrix)[[1]]))
  if (identical(ind.dup, integer(0))) {
    return(count.matrix)
  }
  return(count.matrix[-ind.dup,])
}

remove_dup_cells <- function(count.matrix) {
  ind.dup <- which(duplicated(dimnames(count.matrix)[[2]]))
  if (identical(ind.dup, integer(0))) {
    return(count.matrix)
  }
  return(count.matrix[,-ind.dup])
}

rownames(count_matrix) <- gene_names[,1]
colnames(count_matrix) <- sample_annotations[,1]

count_matrix <- remove_dup_features(count_matrix)
count_matrix <- remove_dup_cells(count_matrix)

human_ret_seurat <- CreateSeuratObject(counts = count_matrix, 
                                       meta.data = sample_annotations, 
                                       project = "human_ret", 
                                       min.cells = 3, 
                                       min.features = 200)
human_ret_seurat
```

Process Mouse Data
```{r}
mouse.data <- Read10X(data.dir = "filtered_feature_bc_matrix")
mouse.data <- remove_dup_features(mouse.data)
mouse.data <- remove_dup_cells(mouse.data)
mouse_ret_seurat <- CreateSeuratObject(counts = mouse.data, 
                                       project = "mouse_ret", 
                                       min.cells = 3, 
                                       min.features = 200)
mouse_ret_seurat
```
Combine
```{r}
ret.list <- list(human = human_ret_seurat, mouse = mouse_ret_seurat)

ret.list <- lapply(X = ret.list, FUN = function(x) {
    x <- NormalizeData(x, verbose = FALSE)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
})
```

# Integration
```{r}
common_features <- function(seurat.list) {
  s1.features <- unique(rownames(seurat.list[[1]]))
  s2.features <- unique(rownames(seurat.list[[2]]))
  return(intersect(s1.features, s2.features))
}

f.names <- rownames(human_ret_seurat)
#f.names <- common_features(ret.list)
ret.anchors <- FindIntegrationAnchors(object.list = ret.list, anchor.features = f.names, dims = 1:20, k.filter = NA)
ret.combined <- IntegrateData(anchorset = ret.anchors, dims = 1:20)
```

# Integrated Analysis
```{r}
DefaultAssay(ret.combined) <- "integrated"

# Run the standard workflow for visualization and clustering
ret.combined <- ScaleData(ret.combined, verbose = FALSE)
ret.combined <- RunPCA(ret.combined, npcs = 50, verbose = FALSE)
# t-SNE and Clustering
ret.combined <- RunUMAP(ret.combined, reduction = "pca", dims = 1:35)
ret.combined <- FindNeighbors(ret.combined, reduction = "pca", dims = 1:35)
ret.combined <- FindClusters(ret.combined, resolution = 0.5)
```

```{r}
# Visualization
p1 <- DimPlot(ret.combined, reduction = "umap", group.by = "orig.ident")
p2 <- DimPlot(ret.combined, reduction = "umap", label = TRUE)
plot_grid(p1, p2)
```

